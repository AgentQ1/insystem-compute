<!DOCTYPE html>
<html>
<head>
  <title>Real-Time Vision Test</title>
  <style>
    body { font-family: Arial; padding: 20px; max-width: 800px; margin: 0 auto; }
    video { width: 100%; max-width: 640px; border: 2px solid #1A73E8; }
    #status { padding: 10px; margin: 10px 0; border-radius: 4px; }
    #status.success { background: #d4edda; color: #155724; }
    #status.error { background: #f8d7da; color: #721c24; }
    button { padding: 10px 20px; margin: 5px; background: #1A73E8; color: white; border: none; border-radius: 4px; cursor: pointer; }
    #results { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>ðŸŽ¥ Real-Time Vision Test</h1>
  
  <div id="status">Loading...</div>
  
  <h2>Step 1: Check API</h2>
  <button onclick="testAPI()">Test API Connection</button>
  
  <h2>Step 2: Test Camera</h2>
  <button onclick="testCamera()">Open Camera</button>
  <button onclick="stopCamera()">Stop Camera</button>
  
  <video id="video" autoplay playsinline></video>
  
  <h2>Step 3: Test Vision Analysis</h2>
  <button onclick="testVisionAPI()">Analyze Current Frame</button>
  
  <div id="results"></div>
  
  <script>
    const API_BASE = 'http://localhost:8080/api/v1';
    const status = document.getElementById('status');
    const results = document.getElementById('results');
    const video = document.getElementById('video');
    let stream = null;
    
    async function testAPI() {
      try {
        const res = await fetch(`${API_BASE}/health`);
        const data = await res.json();
        status.className = 'success';
        status.textContent = `âœ… API Connected: ${JSON.stringify(data)}`;
        
        // Also check models
        const modelsRes = await fetch(`${API_BASE}/hub/models`);
        const modelsData = await modelsRes.json();
        const visionModel = modelsData.models.find(m => m.task === 'vision');
        results.textContent = `Found ${modelsData.count} models\nVision model: ${visionModel ? visionModel.name : 'NOT FOUND'}`;
      } catch (err) {
        status.className = 'error';
        status.textContent = `âŒ API Error: ${err.message}`;
      }
    }
    
    async function testCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'user', width: 1280, height: 720 } 
        });
        video.srcObject = stream;
        status.className = 'success';
        status.textContent = 'âœ… Camera opened successfully';
      } catch (err) {
        status.className = 'error';
        status.textContent = `âŒ Camera Error: ${err.message}`;
      }
    }
    
    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        status.textContent = 'Camera stopped';
      }
    }
    
    async function testVisionAPI() {
      if (!video.srcObject) {
        status.className = 'error';
        status.textContent = 'âŒ Please open camera first';
        return;
      }
      
      status.textContent = 'â³ Analyzing frame...';
      
      try {
        // Capture frame
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        
        // Convert to blob
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
        
        // Send to API
        const formData = new FormData();
        formData.append('image', blob, 'frame.jpg');
        formData.append('prompt', 'What do you see? Describe everything in detail.');
        formData.append('model', 'llava-v1.6-7b-q4');
        formData.append('max_tokens', 150);
        
        const res = await fetch(`${API_BASE}/vision/analyze`, {
          method: 'POST',
          body: formData
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${await res.text()}`);
        }
        
        const data = await res.json();
        status.className = 'success';
        status.textContent = 'âœ… Analysis complete!';
        results.textContent = `Response:\n${JSON.stringify(data, null, 2)}`;
      } catch (err) {
        status.className = 'error';
        status.textContent = `âŒ Analysis Error: ${err.message}`;
        results.textContent = err.stack;
      }
    }
    
    // Auto-test on load
    window.onload = () => {
      setTimeout(testAPI, 500);
    };
  </script>
</body>
</html>
